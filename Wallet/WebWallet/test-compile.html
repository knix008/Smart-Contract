<!DOCTYPE html>
<html>
<head>
    <title>Test Solc Compiler</title>
</head>
<body>
    <h1>Test Solidity Compiler</h1>
    <button onclick="testCompile()">Test Compile</button>
    <pre id="output"></pre>

    <script>
        async function testCompile() {
            const output = document.getElementById('output');
            output.textContent = 'Loading compiler...';

            try {
                // Load solc from official binaries
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://binaries.soliditylang.org/bin/soljson-v0.8.27+commit.40a35a09.js';
                    script.onload = () => {
                        output.textContent += '\nCompiler loaded!';
                        setTimeout(resolve, 100);
                    };
                    script.onerror = (e) => {
                        output.textContent += '\nError loading compiler: ' + e;
                        reject(e);
                    };
                    document.head.appendChild(script);
                });

                output.textContent += '\nInitializing wrapper...';

                // Create solc wrapper
                if (typeof Module === 'undefined' || !Module.cwrap) {
                    throw new Error('Module not available');
                }

                const compileInternal = Module.cwrap('solidity_compile', 'string', ['string', 'number']);
                const solc = {
                    compile: (input) => compileInternal(input, 0)
                };

                output.textContent += '\nWrapper initialized!';

                // Test simple contract
                const source = `
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.27;

contract Test {
    uint256 public value;

    function setValue(uint256 _value) public {
        value = _value;
    }
}
`;

                const input = {
                    language: 'Solidity',
                    sources: {
                        'Test.sol': {
                            content: source
                        }
                    },
                    settings: {
                        outputSelection: {
                            '*': {
                                '*': ['abi', 'evm.bytecode']
                            }
                        }
                    }
                };

                output.textContent += '\nCompiling...';
                const result = solc.compile(JSON.stringify(input));
                const compiled = JSON.parse(result);

                if (compiled.errors) {
                    const errors = compiled.errors.filter(e => e.severity === 'error');
                    if (errors.length > 0) {
                        output.textContent += '\n\nERRORS:\n' + JSON.stringify(errors, null, 2);
                        return;
                    }
                }

                output.textContent += '\n\nSUCCESS!\n';
                output.textContent += JSON.stringify(compiled.contracts, null, 2);

            } catch (error) {
                output.textContent += '\n\nERROR: ' + error.message;
                console.error(error);
            }
        }
    </script>
</body>
</html>
