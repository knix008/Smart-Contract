<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethereum Web Wallet</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 0;
            max-width: 600px;
            width: 100%;
        }

        .header {
            padding: 30px 40px 20px;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background: #f8f9fa;
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
            padding: 40px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        .button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 15px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .button:active {
            transform: translateY(0);
        }

        .button-secondary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .button-secondary:hover {
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.4);
        }

        .success-box {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9em;
            color: #155724;
        }

        .wallet-info {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .wallet-info.show {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .info-item {
            margin-bottom: 15px;
        }

        .info-item:last-child {
            margin-bottom: 0;
        }

        .label {
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .value {
            background: white;
            padding: 12px;
            border-radius: 8px;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: #667eea;
            border: 2px solid #e0e0e0;
        }

        .copy-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            margin-top: 8px;
            transition: background 0.2s;
        }

        .copy-btn:hover {
            background: #5568d3;
        }

        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9em;
            color: #856404;
        }

        .warning strong {
            display: block;
            margin-bottom: 5px;
        }

        .loading {
            text-align: center;
            color: #667eea;
            margin-top: 20px;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9em;
            color: #721c24;
            display: none;
        }

        .error.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê ETH Wallet</h1>
            <p class="subtitle">Simple Ethereum Wallet Generator</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('wallet', event)">
                üíº Wallet Creation
            </button>
            <button class="tab" onclick="showTab('deploy', event)">
                üöÄ Deploy Contract
            </button>
            <button class="tab" onclick="showTab('interact', event)">
                üîó Interact with Contract
            </button>
        </div>

        <div id="wallet-content" class="tab-content active">
            <button class="button" onclick="createNewAccount()">
                ‚ûï Create New Account
            </button>

        <div class="loading" id="loading">
            <p>Generating your new wallet...</p>
        </div>

        <div class="error" id="error"></div>

        <div class="wallet-info" id="walletInfo">
            <div class="info-item">
                <div class="label">Address:</div>
                <div class="value" id="address"></div>
                <button class="copy-btn" onclick="copyToClipboard('address')">üìã Copy Address</button>
            </div>

            <div class="info-item">
                <div class="label">Private Key:</div>
                <div class="value" id="privateKey"></div>
                <button class="copy-btn" onclick="copyToClipboard('privateKey')">üìã Copy Private Key</button>
            </div>

            <button class="button button-secondary" onclick="downloadEnvFile()">
                üíæ Download .env File
            </button>

            <button class="button" onclick="checkWalletEthBalance()" style="width: 100%; margin-top: 10px; background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);">
                üí∞ Check ETH Balance
            </button>

            <div class="success-box" id="downloadSuccess" style="display: none;">
                ‚úì Click the button above to download your wallet credentials as a .env file<br>
                üí° Use the "üí∞ Check ETH Balance" button to see your account's ETH balance on the network
            </div>

            <div class="wallet-info" id="ethBalanceResult" style="display: none; margin-top: 15px;">
                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #4caf50;">
                    <div style="font-weight: 600; color: #2e7d32; margin-bottom: 5px;">üí∞ ETH Balance Retrieved</div>
                    <div style="color: #555; font-size: 0.9em;">Balance checked using your custom RPC endpoint</div>
                </div>
                
                <div class="info-item">
                    <div class="label">ETH Balance:</div>
                    <div class="value" id="ethBalanceValue"></div>
                    <button class="copy-btn" onclick="copyToClipboard('ethBalanceValue')">üìã Copy Balance</button>
                </div>
                <div class="info-item">
                    <div class="label">Network:</div>
                    <div class="value" id="ethBalanceNetwork"></div>
                </div>
                <div class="info-item">
                    <div class="label">Wallet Address:</div>
                    <div class="value" id="ethBalanceAddress"></div>
                    <button class="copy-btn" onclick="copyToClipboard('ethBalanceAddress')">üìã Copy Address</button>
                </div>
            </div>

            <div class="loading" id="balanceLoading" style="display: none;">
                <p>Checking ETH balance...</p>
            </div>

            <div class="error" id="balanceError" style="display: none;"></div>

            <div class="warning">
                <strong>‚ö†Ô∏è Important:</strong>
                Save your private key securely! Never share it with anyone.
                The .env file contains your wallet credentials. Store it safely and never commit it to version control (add it to .gitignore).
            </div>
        </div>
        </div>

        <div id="deploy-content" class="tab-content">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                <h3 style="margin: 0 0 10px 0; font-size: 1.2em;">üì¶ Deploy Compiled Smart Contract</h3>
                <p style="margin: 0; opacity: 0.95; font-size: 0.9em;">
                    First compile your contract locally with <code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px;">npm run compile:erc20</code>,
                    then upload the compiled JSON file below to deploy it.
                </p>
            </div>

            <div class="info-item">
                <div class="label">1Ô∏è‚É£ Upload Compiled Contract JSON:</div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="file" id="compiledFile" accept=".json" style="flex: 1;">
                    <button class="button" onclick="loadCompiledContract()" style="width: auto; padding: 10px 20px; margin: 0;">
                        üìÅ Load
                    </button>
                </div>
                <small style="color: #666; display: block; margin-top: 8px;">
                    üìÇ Select from <code>compiled/</code> directory: <code>MyToken.json</code> or <code>SimpleToken.json</code>
                </small>
            </div>

            <div class="loading" id="compileLoading">
                <p>Loading compiled contract...</p>
            </div>

            <div class="error" id="compileError"></div>

            <div class="wallet-info" id="compileResults">
                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
                    <div style="font-weight: 600; color: #2e7d32; margin-bottom: 5px;">‚úÖ Contract Loaded Successfully!</div>
                    <div id="loadedContractName" style="color: #555; font-size: 0.9em;"></div>
                </div>

                <div class="info-item">
                    <div class="label">2Ô∏è‚É£ Select Network:</div>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <select id="network" style="flex: 1; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 1em;">
                            <option value="http://localhost:8545">üè† Local (Hardhat/Ganache)</option>
                            <option value="sepolia">üß™ Sepolia Testnet</option>
                            <option value="mainnet">‚ö†Ô∏è Ethereum Mainnet</option>
                        </select>
                        <button class="button" onclick="loadNetworkFromEnv()" style="width: auto; padding: 10px 20px; margin: 0; font-size: 0.9em;">
                            üìã Load from .env
                        </button>
                    </div>
                    <small style="color: #666; display: block; margin-top: -10px; margin-bottom: 15px;">
                        üí° Auto-loaded from .env: DEFAULT_NETWORK=sepolia<br>
                        üåê Using custom RPC_URL from .env for deployment<br>
                        ‚úèÔ∏è You can change this selection if needed
                    </small>
                </div>

                <div class="info-item">
                    <div class="label">3Ô∏è‚É£ Private Key:</div>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="password" id="deployPrivateKey" placeholder="Paste private key from .env file" style="flex: 1; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-family: 'Courier New', monospace; font-size: 0.95em;">
                        <button class="button" onclick="loadPrivateKeyFromEnv()" style="width: auto; padding: 10px 20px; margin: 0; font-size: 0.9em;">
                            üìã Load from .env
                        </button>
                    </div>
                    <small style="color: #666; display: block; margin-bottom: 15px;">
                        ‚ö†Ô∏è Auto-loaded from .env - Make sure you have ETH in this account for gas fees<br>
                        ‚úèÔ∏è You can change this private key if needed
                    </small>
                </div>

                <div class="info-item">
                    <div class="label">4Ô∏è‚É£ Constructor Arguments:</div>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="constructorArgs" placeholder="e.g., 0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb" style="flex: 1; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-family: 'Courier New', monospace; font-size: 0.9em;">
                        <button class="button" onclick="loadConstructorArgsFromEnv()" style="width: auto; padding: 10px 20px; margin: 0; font-size: 0.9em;">
                            üìã Load from .env
                        </button>
                    </div>
                    <small style="color: #666; display: block; margin-bottom: 15px;">
                        <strong>MyToken:</strong> Enter your wallet address (initialOwner)<br>
                        <strong>SimpleToken:</strong> "MyToken", "MTK", 1000000 (comma-separated)<br>
                        üí° Auto-loaded from .env when contract is selected - You can modify as needed
                    </small>
                </div>

                <button class="button button-secondary" onclick="deployContract()" style="width: 100%; font-size: 1.1em; padding: 15px;">
                    üöÄ Deploy Contract to Blockchain
                </button>

                <button class="button" onclick="loadAllFromEnv()" style="width: 100%; font-size: 1.0em; padding: 12px; margin-top: 10px; background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);">
                    üìã Load All Configuration from .env
                </button>

                <button class="button" onclick="resetToDefaults()" style="width: 100%; font-size: 1.0em; padding: 12px; margin-top: 5px; background: linear-gradient(135deg, #6c757d 0%, #495057 100%);">
                    üîÑ Reset to .env Defaults
                </button>
            </div>

            <div class="loading" id="deployLoading">
                <p>Deploying contract...</p>
            </div>

            <div class="error" id="deployError"></div>

            <div class="wallet-info" id="deployResults">
                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
                    <div style="font-weight: 600; color: #2e7d32; margin-bottom: 5px;">‚úÖ Contract Deployed Successfully!</div>
                    <div style="color: #555; font-size: 0.9em;">Using custom RPC URL from .env configuration</div>
                </div>

                <div class="info-item">
                    <div class="label">Contract Address:</div>
                    <div class="value" id="contractAddress"></div>
                    <button class="copy-btn" onclick="copyToClipboard('contractAddress')">üìã Copy Address</button>
                </div>

                <div class="info-item">
                    <div class="label">Transaction Hash:</div>
                    <div class="value" id="txHash"></div>
                    <button class="copy-btn" onclick="copyToClipboard('txHash')">üìã Copy TX Hash</button>
                </div>
            </div>
        </div>

        <div id="interact-content" class="tab-content">
            <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                <h3 style="margin: 0 0 10px 0; font-size: 1.2em;">üîó Interact with Deployed Contract</h3>
                <p style="margin: 0; opacity: 0.95; font-size: 0.9em;">
                    Connect to your deployed smart contract using the address from your <code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px;">.env</code> file.
                    Call functions, check balances, and manage your contract.
                </p>
            </div>

            <div class="info-item">
                <div class="label">1Ô∏è‚É£ Contract Address:</div>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="contractAddressInput" placeholder="Enter contract address" style="flex: 1; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-family: 'Courier New', monospace; font-size: 0.9em;">
                    <button class="button" onclick="loadContractAddressFromEnv()" style="width: auto; padding: 10px 20px; margin: 0; font-size: 0.9em;">
                        üìã Load from .env
                    </button>
                </div>
                <small style="color: #666; display: block; margin-bottom: 15px;">
                    üí° Auto-loaded from .env: CONTRACT_ADDRESS<br>
                    ‚úèÔ∏è You can change this address if needed
                </small>
            </div>

            <div class="info-item">
                <div class="label">2Ô∏è‚É£ Upload Contract ABI:</div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="file" id="contractAbiFile" accept=".json" style="flex: 1;">
                    <button class="button" onclick="loadContractAbi()" style="width: auto; padding: 10px 20px; margin: 0;">
                        üìÅ Load ABI
                    </button>
                </div>
                <small style="color: #666; display: block; margin-top: 8px;">
                    üìÇ Select from <code>compiled/</code> directory: <code>MyToken.json</code> or <code>SimpleToken.json</code><br>
                    üí° These files contain both ABI and bytecode from contract compilation<br>
                    ‚ö†Ô∏è If files don't exist, run: <code>npm run compile:erc20</code> or <code>npm run compile:simple</code>
                </small>
            </div>

            <div class="loading" id="contractLoading">
                <p>Loading contract...</p>
            </div>

            <div class="error" id="contractError"></div>

            <div class="wallet-info" id="contractInfo" style="display: none;">
                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
                    <div style="font-weight: 600; color: #2e7d32; margin-bottom: 5px;">‚úÖ Contract Connected!</div>
                    <div id="contractDetails" style="color: #555; font-size: 0.9em;"></div>
                </div>

                <div class="info-item">
                    <div class="label">3Ô∏è‚É£ Private Key for Transactions:</div>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="password" id="interactPrivateKey" placeholder="Paste private key" style="flex: 1; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-family: 'Courier New', monospace; font-size: 0.95em;">
                        <button class="button" onclick="loadInteractPrivateKeyFromEnv()" style="width: auto; padding: 10px 20px; margin: 0; font-size: 0.9em;">
                            üìã Load from .env
                        </button>
                    </div>
                </div>

                <div class="info-item">
                    <div class="label">4Ô∏è‚É£ Contract Functions:</div>
                    <div id="contractFunctions" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p style="color: #666; margin: 0;">Available functions will appear here after loading the contract ABI.</p>
                    </div>
                </div>

                <div class="info-item">
                    <div class="label">5Ô∏è‚É£ Quick Actions:</div>
                    <div style="margin-bottom: 10px;">
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="balanceCheckAddress" placeholder="Address to check balance (leave empty for your wallet)" style="flex: 1; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-family: 'Courier New', monospace; font-size: 0.9em;">
                            <button class="button" onclick="fillMyAddress()" style="width: auto; padding: 10px 15px; margin: 0; font-size: 0.85em;">
                                üë§ My Address
                            </button>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <button class="button" onclick="getTokenBalance()" style="padding: 12px; font-size: 0.9em;">
                            üí∞ Check Balance
                        </button>
                        <button class="button" onclick="getTokenInfo()" style="padding: 12px; font-size: 0.9em;">
                            ‚ÑπÔ∏è Token Info
                        </button>
                    </div>
                </div>

                <div class="info-item">
                    <div class="label">6Ô∏è‚É£ Transfer Tokens:</div>
                    <input type="text" id="transferTo" placeholder="Recipient address (0x...)" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; margin-bottom: 10px; font-family: 'Courier New', monospace; font-size: 0.9em;">
                    <input type="text" id="transferAmount" placeholder="Amount (e.g., 100)" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; margin-bottom: 15px;">
                    <button class="button button-secondary" onclick="transferTokens()" style="width: 100%; padding: 12px;">
                        üì§ Transfer Tokens
                    </button>
                </div>
            </div>

            <div class="loading" id="transactionLoading">
                <p>Processing transaction...</p>
            </div>

            <div class="wallet-info" id="transactionResults" style="display: none;">
                <div class="info-item">
                    <div class="label">Transaction Hash:</div>
                    <div class="value" id="transactionHash"></div>
                    <button class="copy-btn" onclick="copyToClipboard('transactionHash')">üìã Copy TX Hash</button>
                </div>
                <div class="info-item">
                    <div class="label">Result:</div>
                    <div class="value" id="transactionResult"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { ethers } from 'https://cdn.jsdelivr.net/npm/ethers@6.13.0/+esm';

        window.ethers = ethers;

        console.log('Ethers.js loaded successfully');
    </script>
    <script>
        let currentAddress = '';
        let currentPrivateKey = '';
        let compiledContract = null;

        // Configuration from .env file (loaded as defaults)
        const envConfig = {
            network: 'sepolia',
            privateKey: '0x0d839bceee54a939a1c173bdeff27f4366ab40f047aa48e389140aee3af023e4',
            rpcUrl: 'https://sepolia.infura.io/v3/135887a7cd1544ee9c68a3d6fc24d10e',
            myTokenOwner: '0x0e2287f4094e7bb10FF48e64aA6cC26C9B93994f',
            simpleTokenName: 'MyToken',
            simpleTokenSymbol: 'MTK',
            simpleTokenSupply: '1000000',
            contractAddress: '0x0e2287f4094e7bb10FF48e64aA6cC26C9B93994f'
        };

        // Load default values from .env on page load
        window.addEventListener('DOMContentLoaded', function() {
            loadDefaultValuesFromEnv();
            
            // Show a subtle notification that defaults are loaded
            setTimeout(() => {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #d4edda;
                    color: #155724;
                    padding: 12px 20px;
                    border-radius: 8px;
                    border-left: 4px solid #28a745;
                    z-index: 1000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    font-size: 0.9em;
                `;
                notification.innerHTML = '‚úÖ Default values loaded from .env file';
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.5s';
                    setTimeout(() => notification.remove(), 500);
                }, 3000);
            }, 1000);
        });

        function loadDefaultValuesFromEnv() {
            // Auto-load network selection
            const networkSelect = document.getElementById('network');
            if (networkSelect && envConfig.network) {
                networkSelect.value = envConfig.network;
            }

            // Auto-load private key
            const privateKeyInput = document.getElementById('deployPrivateKey');
            if (privateKeyInput && envConfig.privateKey) {
                privateKeyInput.value = envConfig.privateKey;
            }

            console.log('‚úÖ Default values loaded from .env configuration');
        }

        // Load pre-compiled contract from JSON
        function loadCompiledContract() {
            const fileInput = document.getElementById('compiledFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a compiled JSON file first');
                return;
            }

            const compileLoading = document.getElementById('compileLoading');
            const compileError = document.getElementById('compileError');
            const compileResults = document.getElementById('compileResults');

            compileLoading.classList.add('show');
            compileError.classList.remove('show');
            compileResults.classList.remove('show');

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const json = JSON.parse(event.target.result);

                    // Validate JSON structure
                    if (!json.abi || !json.bytecode) {
                        throw new Error('Invalid compiled contract format. Must contain "abi" and "bytecode" fields.');
                    }

                    // Store in global variable
                    compiledContract = {
                        abi: json.abi,
                        evm: {
                            bytecode: {
                                object: json.bytecode
                            }
                        }
                    };

                    // Show contract info
                    const contractName = json.contractName || 'Contract';
                    const bytecodeSize = Math.round(json.bytecode.length / 2);
                    const abiMethods = json.abi.filter(item => item.type === 'function').length;

                    document.getElementById('loadedContractName').innerHTML = `
                        <strong>Contract Name:</strong> ${contractName}<br>
                        <strong>Bytecode Size:</strong> ${bytecodeSize} bytes<br>
                        <strong>Functions:</strong> ${abiMethods} public functions
                    `;

                    // Hide loading, show deployment section
                    compileLoading.classList.remove('show');
                    compileResults.classList.add('show');

                    // Auto-load constructor arguments based on contract type
                    setTimeout(() => {
                        autoLoadConstructorArgs();
                    }, 100);

                    console.log('‚úÖ Contract loaded:', contractName);

                } catch (error) {
                    console.error('Error loading contract:', error);
                    compileLoading.classList.remove('show');
                    compileError.textContent = 'Error loading compiled contract: ' + error.message;
                    compileError.classList.add('show');
                }
            };
            reader.readAsText(file);
        }


        async function deployContract() {
            if (!compiledContract) {
                alert('Please compile the contract first!');
                return;
            }

            const network = document.getElementById('network').value;
            const privateKey = document.getElementById('deployPrivateKey').value;
            const constructorArgs = document.getElementById('constructorArgs').value;

            const deployLoading = document.getElementById('deployLoading');
            const deployResults = document.getElementById('deployResults');
            const deployError = document.getElementById('deployError');

            if (!privateKey) {
                deployError.textContent = 'Please provide a private key';
                deployError.classList.add('show');
                return;
            }

            deployLoading.classList.add('show');
            deployResults.classList.remove('show');
            deployError.classList.remove('show');

            try {
                let provider;
                // Use RPC_URL from .env file for enhanced flexibility and consistency
                if (network === 'sepolia' || network === 'mainnet') {
                    // Use custom RPC_URL from .env file for better performance and reliability
                    provider = new ethers.JsonRpcProvider(envConfig.rpcUrl);
                    console.log('Using custom RPC URL from .env:', envConfig.rpcUrl);
                } else if (network === 'http://localhost:8545') {
                    // Use local development network
                    provider = new ethers.JsonRpcProvider(network);
                    console.log('Using local development network:', network);
                } else {
                    // Fallback for other custom URLs
                    provider = new ethers.JsonRpcProvider(network);
                    console.log('Using custom network URL:', network);
                }

                const wallet = new ethers.Wallet(privateKey, provider);

                const factory = new ethers.ContractFactory(
                    compiledContract.abi,
                    compiledContract.evm.bytecode.object,
                    wallet
                );

                let args = [];
                if (constructorArgs.trim()) {
                    args = constructorArgs.split(',').map(arg => arg.trim());
                }

                const contract = await factory.deploy(...args);
                await contract.waitForDeployment();

                const address = await contract.getAddress();
                const deployTx = contract.deploymentTransaction();

                document.getElementById('contractAddress').textContent = address;
                document.getElementById('txHash').textContent = deployTx.hash;

                // Log successful deployment with RPC info
                console.log('‚úÖ Contract deployed successfully!');
                console.log('Contract Address:', address);
                console.log('Transaction Hash:', deployTx.hash);
                console.log('Network:', network);
                console.log('RPC URL used:', envConfig.rpcUrl);

                deployLoading.classList.remove('show');
                deployResults.classList.add('show');

            } catch (error) {
                console.error('Deployment error:', error);
                deployLoading.classList.remove('show');
                deployError.textContent = 'Deployment failed: ' + error.message;
                deployError.classList.add('show');
            }
        }

        async function createNewAccount() {
            const loading = document.getElementById('loading');
            const walletInfo = document.getElementById('walletInfo');
            const errorDiv = document.getElementById('error');
            const downloadSuccess = document.getElementById('downloadSuccess');

            // Hide previous results
            loading.classList.add('show');
            walletInfo.classList.remove('show');
            errorDiv.classList.remove('show');
            downloadSuccess.style.display = 'none';

            try {
                // Wait for ethers to be loaded
                await new Promise(resolve => {
                    const checkEthers = setInterval(() => {
                        if (window.ethers) {
                            clearInterval(checkEthers);
                            resolve();
                        }
                    }, 100);
                });

                // Create a random wallet
                const wallet = window.ethers.Wallet.createRandom();

                // Store credentials
                currentAddress = wallet.address;
                currentPrivateKey = wallet.privateKey;

                // Display wallet info
                document.getElementById('address').textContent = wallet.address;
                document.getElementById('privateKey').textContent = wallet.privateKey;

                // Hide loading and show wallet info
                setTimeout(() => {
                    loading.classList.remove('show');
                    walletInfo.classList.add('show');
                    downloadSuccess.style.display = 'block';
                    
                    // Show hint about checking ETH balance
                    setTimeout(() => {
                        const hint = document.createElement('div');
                        hint.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: #d1ecf1;
                            color: #0c5460;
                            padding: 12px 20px;
                            border-radius: 8px;
                            border-left: 4px solid #17a2b8;
                            z-index: 1000;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                            font-size: 0.9em;
                            max-width: 300px;
                        `;
                        hint.innerHTML = 'üí° Wallet created! Click "üí∞ Check ETH Balance" to see your account balance on the network.';
                        document.body.appendChild(hint);
                        
                        setTimeout(() => {
                            hint.style.opacity = '0';
                            hint.style.transition = 'opacity 0.5s';
                            setTimeout(() => hint.remove(), 500);
                        }, 5000);
                    }, 1000);
                }, 500);

            } catch (error) {
                console.error('Error:', error);
                loading.classList.remove('show');
                errorDiv.textContent = 'Error creating wallet: ' + error.message;
                errorDiv.classList.add('show');
            }
        }

        function downloadEnvFile() {
            if (!currentAddress || !currentPrivateKey) {
                alert('Please create a wallet first!');
                return;
            }

            // Create .env file content
            const envContent = `# Ethereum Wallet Configuration
# Generated on ${new Date().toISOString()}
# DO NOT commit this file to version control!

WALLET_ADDRESS=${currentAddress}
PRIVATE_KEY=${currentPrivateKey}
`;

            // Create a blob and download
            const blob = new Blob([envContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '.env';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // Show success message
            alert('‚úì .env file downloaded! Save it in a secure location.');
        }

        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).textContent;

            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                btn.style.background = '#28a745';

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#667eea';
                }, 2000);
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        async function checkWalletEthBalance() {
            if (!currentAddress) {
                alert('Please create a wallet first!');
                return;
            }

            const balanceLoading = document.getElementById('balanceLoading');
            const ethBalanceResult = document.getElementById('ethBalanceResult');
            const balanceError = document.getElementById('balanceError');

            // Show loading and hide previous results
            balanceLoading.style.display = 'block';
            ethBalanceResult.style.display = 'none';
            balanceError.style.display = 'none';

            try {
                // Use the RPC URL from envConfig
                const provider = new window.ethers.JsonRpcProvider(envConfig.rpcUrl);
                
                console.log('Checking ETH balance for:', currentAddress);
                console.log('Using RPC URL:', envConfig.rpcUrl);

                const balance = await provider.getBalance(currentAddress);
                const ethBalance = window.ethers.formatEther(balance);

                // Get network info
                const network = await provider.getNetwork();
                const networkName = network.name === 'unknown' ? 'Sepolia Testnet' : network.name;

                // Display results
                document.getElementById('ethBalanceValue').textContent = `${ethBalance} ETH`;
                document.getElementById('ethBalanceNetwork').textContent = `${networkName} (Chain ID: ${network.chainId})`;
                document.getElementById('ethBalanceAddress').textContent = currentAddress;

                balanceLoading.style.display = 'none';
                ethBalanceResult.style.display = 'block';

                // Show faucet info if balance is 0
                if (parseFloat(ethBalance) === 0) {
                    setTimeout(() => {
                        alert('üí° Your ETH balance is 0.\n\nFor Sepolia testnet, you can get free ETH from:\n‚Ä¢ https://faucets.chain.link/sepolia\n‚Ä¢ https://sepoliafaucet.com\n\nYou need ETH to pay for transaction gas fees.');
                    }, 1000);
                }

                console.log('‚úÖ ETH Balance check successful:', ethBalance, 'ETH');

            } catch (error) {
                console.error('ETH balance check error:', error);
                balanceLoading.style.display = 'none';
                balanceError.textContent = 'Error checking ETH balance: ' + error.message;
                balanceError.style.display = 'block';
            }
        }

        function loadPrivateKeyFromEnv() {
            // Private key from your .env file
            document.getElementById('deployPrivateKey').value = envConfig.privateKey;
            
            // Show feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úì Loaded!';
            btn.style.background = '#28a745';

            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '#667eea';
            }, 2000);
        }

        function loadConstructorArgsFromEnv() {
            // Check which contract is loaded to determine the correct constructor arguments
            const contractName = document.getElementById('loadedContractName').textContent;
            let constructorArgs = '';
            
            if (contractName.includes('MyToken') || contractName.includes('MyERC20Token')) {
                // MyToken requires: initialOwner (address)
                constructorArgs = envConfig.myTokenOwner;
            } else if (contractName.includes('SimpleToken')) {
                // SimpleToken requires: name, symbol, initialSupply
                constructorArgs = `${envConfig.simpleTokenName}, ${envConfig.simpleTokenSymbol}, ${envConfig.simpleTokenSupply}`;
            } else {
                // Default to MyToken arguments if contract type is unclear
                constructorArgs = envConfig.myTokenOwner;
            }
            
            document.getElementById('constructorArgs').value = constructorArgs;
            
            // Show feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úì Loaded!';
            btn.style.background = '#28a745';

            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '#667eea';
            }, 2000);
        }

        function autoLoadConstructorArgs() {
            // Automatically load constructor args when contract is loaded
            const contractName = document.getElementById('loadedContractName').textContent;
            if (contractName) {
                let constructorArgs = '';
                
                if (contractName.includes('MyToken') || contractName.includes('MyERC20Token')) {
                    constructorArgs = envConfig.myTokenOwner;
                } else if (contractName.includes('SimpleToken')) {
                    constructorArgs = `${envConfig.simpleTokenName}, ${envConfig.simpleTokenSymbol}, ${envConfig.simpleTokenSupply}`;
                } else {
                    constructorArgs = envConfig.myTokenOwner;
                }
                
                document.getElementById('constructorArgs').value = constructorArgs;
            }
        }

        function loadNetworkFromEnv() {
            // Default network from .env file
            document.getElementById('network').value = envConfig.network;
            
            // Show feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úì Loaded!';
            btn.style.background = '#28a745';

            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '#667eea';
            }, 2000);
        }

        function loadAllFromEnv() {
            // Load all configuration from .env at once
            loadNetworkFromEnv();
            loadPrivateKeyFromEnv();
            loadConstructorArgsFromEnv();
            
            // Show overall feedback
            alert('‚úÖ All configuration loaded from .env file!\n\nüìã Network: Sepolia (using custom RPC)\nüîë Private Key: Loaded\n‚öôÔ∏è Constructor Args: Loaded');
        }

        function resetToDefaults() {
            // Reset all fields to .env defaults
            loadDefaultValuesFromEnv();
            autoLoadConstructorArgs();
            
            // Show feedback
            alert('üîÑ All fields reset to .env default values!\n\nYou can now modify any field as needed.');
        }

        // Contract Interaction Functions
        let contractInstance = null;
        let contractAbi = null;

        function loadContractAddressFromEnv() {
            document.getElementById('contractAddressInput').value = envConfig.contractAddress;
            
            // Show feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úì Loaded!';
            btn.style.background = '#28a745';

            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '#667eea';
            }, 2000);
        }

        function loadInteractPrivateKeyFromEnv() {
            document.getElementById('interactPrivateKey').value = envConfig.privateKey;
            
            // Show feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úì Loaded!';
            btn.style.background = '#28a745';

            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '#667eea';
            }, 2000);
        }

        function loadContractAbi() {
            const fileInput = document.getElementById('contractAbiFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a contract JSON file first');
                return;
            }

            const contractLoading = document.getElementById('contractLoading');
            const contractError = document.getElementById('contractError');
            const contractInfo = document.getElementById('contractInfo');

            contractLoading.style.display = 'block';
            contractError.style.display = 'none';
            contractInfo.style.display = 'none';

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const json = JSON.parse(event.target.result);

                    if (!json.abi) {
                        throw new Error('Invalid contract file. Must contain "abi" field.');
                    }

                    contractAbi = json.abi;
                    const contractAddress = document.getElementById('contractAddressInput').value;

                    if (!contractAddress) {
                        throw new Error('Please enter a contract address first');
                    }

                    // Create contract instance
                    const provider = new ethers.JsonRpcProvider(envConfig.rpcUrl);
                    contractInstance = new ethers.Contract(contractAddress, contractAbi, provider);

                    // Display contract info
                    const contractName = json.contractName || 'Contract';
                    const functionCount = contractAbi.filter(item => item.type === 'function').length;
                    
                    document.getElementById('contractDetails').innerHTML = `
                        <strong>Contract:</strong> ${contractName}<br>
                        <strong>Address:</strong> ${contractAddress}<br>
                        <strong>Functions:</strong> ${functionCount} available
                    `;

                    // Display contract functions
                    displayContractFunctions();

                    contractLoading.style.display = 'none';
                    contractInfo.style.display = 'block';

                    console.log('‚úÖ Contract connected:', contractAddress);

                } catch (error) {
                    console.error('Error loading contract:', error);
                    contractLoading.style.display = 'none';
                    contractError.textContent = 'Error loading contract: ' + error.message;
                    contractError.style.display = 'block';
                }
            };

            reader.readAsText(file);
        }

        function displayContractFunctions() {
            if (!contractAbi) return;

            const functionsDiv = document.getElementById('contractFunctions');
            const functions = contractAbi.filter(item => item.type === 'function');

            let functionsHtml = '<h4 style="margin: 0 0 10px 0; color: #333;">Available Functions:</h4>';
            
            functions.forEach(func => {
                const inputs = func.inputs.map(input => `${input.name}: ${input.type}`).join(', ');
                const isView = func.stateMutability === 'view' || func.stateMutability === 'pure';
                const icon = isView ? 'üëÄ' : '‚úèÔ∏è';
                
                functionsHtml += `
                    <div style="background: white; padding: 10px; margin: 5px 0; border-radius: 6px; border-left: 3px solid ${isView ? '#17a2b8' : '#28a745'};">
                        <strong>${icon} ${func.name}</strong><br>
                        <small style="color: #666;">${inputs || 'No parameters'}</small>
                    </div>
                `;
            });

            functionsDiv.innerHTML = functionsHtml;
        }

        function fillMyAddress() {
            document.getElementById('balanceCheckAddress').value = envConfig.myTokenOwner;
            
            // Show feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úì Filled!';
            btn.style.background = '#28a745';

            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '#667eea';
            }, 1500);
        }

        async function getTokenBalance() {
            if (!contractInstance) {
                alert('Please load the contract first');
                return;
            }

            // Show loading and hide previous results
            document.getElementById('transactionLoading').style.display = 'block';
            document.getElementById('transactionResults').style.display = 'none';

            try {
                // Get address from input field, or use wallet address as default
                let addressToCheck = document.getElementById('balanceCheckAddress').value.trim();
                if (!addressToCheck) {
                    addressToCheck = envConfig.myTokenOwner;
                }

                // Validate address format
                if (!ethers.isAddress(addressToCheck)) {
                    throw new Error('Invalid Ethereum address format');
                }

                console.log('Checking balance for address:', addressToCheck);

                const balance = await contractInstance.balanceOf(addressToCheck);
                const decimals = await contractInstance.decimals();
                const symbol = await contractInstance.symbol();
                
                const formattedBalance = ethers.formatUnits(balance, decimals);
                
                const resultText = `Balance: ${formattedBalance} ${symbol}\nAddress: ${addressToCheck}`;
                
                document.getElementById('transactionResult').textContent = resultText;
                document.getElementById('transactionHash').textContent = 'N/A (View call)';
                
                // Hide loading and show results
                document.getElementById('transactionLoading').style.display = 'none';
                document.getElementById('transactionResults').style.display = 'block';
                
                console.log('‚úÖ Balance check successful:', formattedBalance, symbol);
            } catch (error) {
                console.error('Balance check error:', error);
                document.getElementById('transactionLoading').style.display = 'none';
                alert('Error getting balance: ' + error.message);
            }
        }

        async function getTokenInfo() {
            if (!contractInstance) {
                alert('Please load the contract first');
                return;
            }

            // Show loading and hide previous results
            document.getElementById('transactionLoading').style.display = 'block';
            document.getElementById('transactionResults').style.display = 'none';

            try {
                console.log('Fetching token information...');

                const name = await contractInstance.name();
                const symbol = await contractInstance.symbol();
                const decimals = await contractInstance.decimals();
                const totalSupply = await contractInstance.totalSupply();
                
                const formattedSupply = ethers.formatUnits(totalSupply, decimals);
                
                // Try to get additional info if available
                let additionalInfo = '';
                try {
                    const owner = await contractInstance.owner();
                    additionalInfo += `\nOwner: ${owner}`;
                } catch {
                    // Owner function might not exist
                }

                const info = `Token Information:
Name: ${name}
Symbol: ${symbol}
Decimals: ${decimals}
Total Supply: ${formattedSupply} ${symbol}${additionalInfo}`;
                
                document.getElementById('transactionResult').textContent = info;
                document.getElementById('transactionHash').textContent = 'N/A (View call)';
                
                // Hide loading and show results
                document.getElementById('transactionLoading').style.display = 'none';
                document.getElementById('transactionResults').style.display = 'block';
                
                console.log('‚úÖ Token info retrieved:', { name, symbol, decimals, totalSupply: formattedSupply });
            } catch (error) {
                console.error('Token info error:', error);
                document.getElementById('transactionLoading').style.display = 'none';
                alert('Error getting token info: ' + error.message);
            }
        }

        async function transferTokens() {
            if (!contractInstance) {
                alert('Please load the contract first');
                return;
            }

            const privateKey = document.getElementById('interactPrivateKey').value;
            const recipientAddress = document.getElementById('transferTo').value;
            const amount = document.getElementById('transferAmount').value;

            if (!privateKey || !recipientAddress || !amount) {
                alert('Please fill in all fields');
                return;
            }

            const transactionLoading = document.getElementById('transactionLoading');
            const transactionResults = document.getElementById('transactionResults');

            transactionLoading.style.display = 'block';
            transactionResults.style.display = 'none';

            try {
                const provider = new ethers.JsonRpcProvider(envConfig.rpcUrl);
                const wallet = new ethers.Wallet(privateKey, provider);
                const contractWithSigner = contractInstance.connect(wallet);

                const decimals = await contractInstance.decimals();
                const amountInWei = ethers.parseUnits(amount, decimals);

                const tx = await contractWithSigner.transfer(recipientAddress, amountInWei);
                
                document.getElementById('transactionHash').textContent = tx.hash;
                document.getElementById('transactionResult').textContent = `Transferred ${amount} tokens to ${recipientAddress}`;
                
                transactionLoading.style.display = 'none';
                transactionResults.style.display = 'block';
                
                console.log('Transfer successful:', tx.hash);
                
                // Wait for confirmation
                await tx.wait();
                console.log('Transfer confirmed');
                
            } catch (error) {
                console.error('Transfer error:', error);
                transactionLoading.style.display = 'none';
                alert('Transfer failed: ' + error.message);
            }
        }

        // Auto-load contract address when interact tab is shown
        function showTab(tabName, event) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName + '-content').classList.add('active');
            event.target.classList.add('active');

            // Auto-load defaults for interact tab
            if (tabName === 'interact') {
                setTimeout(() => {
                    document.getElementById('contractAddressInput').value = envConfig.contractAddress;
                    document.getElementById('interactPrivateKey').value = envConfig.privateKey;
                }, 100);
            }
        }
    </script>
</body>
</html>
